"use strict";var _prototypeProperties=function(e,n,t){n&&Object.defineProperties(e,n),t&&Object.defineProperties(e.prototype,t)},_get=function e(n,t,r){var i=Object.getOwnPropertyDescriptor(n,t);if(void 0===i){var o=Object.getPrototypeOf(n);return null===o?void 0:e(o,t,r)}if("value"in i&&i.writable)return i.value;var u=i.get;if(void 0!==u)return u.call(r)},_inherits=function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),n&&(e.__proto__=n)},_classCallCheck=function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")},_=require("lodash"),path=require("path"),fs=require("fs"),MDBClient=require("mongodb").MongoClient,ObjectId=require("mongodb").ObjectId,DatabaseClient=require("./client"),isObject=require("../validate").isObject,deepTraverse=require("../util").deepTraverse,MongoClient=function(e){function n(e,t){_classCallCheck(this,n),_get(Object.getPrototypeOf(n.prototype),"constructor",this).call(this,e),this._mongo=t}return _inherits(n,e),_prototypeProperties(n,{connect:{value:function(e,t){return void 0===t&&(t={}),new Promise(function(r,i){MDBClient.connect(e,t,function(t,o){return t?i(t):r(new n(e,o))})})},writable:!0,configurable:!0}},{save:{value:function(e,n,t){var r=this;return new Promise(function(i,o){var u=r._mongo.collection(e);null===n?u.insertOne(t,function(e,n){return e?o(e):n.hasOwnProperty("insertedId")&&null!==n.insertedId?i(n.insertedId):o(new Error("Save failed to generate ID for object."))}):u.updateOne({_id:n},{$set:t},{upsert:!0},function(e,n){return e?o(e):i()})})},writable:!0,configurable:!0},delete:{value:function(e,n){var t=this;return new Promise(function(r,i){null===n&&r(0),t._mongo.collection(e).deleteOne({_id:n},{w:1},function(e,n){return e?i(e):r(n.deletedCount)})})},writable:!0,configurable:!0},deleteOne:{value:function(e,n){var t=this;return n=castQueryIds(n),new Promise(function(r,i){t._mongo.collection(e).deleteOne(n,{w:1},function(e,n){return e?i(e):r(n.deletedCount)})})},writable:!0,configurable:!0},deleteMany:{value:function(e,n){var t=this;return n=castQueryIds(n),new Promise(function(r,i){t._mongo.collection(e).deleteMany(n,{w:1},function(e,n){return e?i(e):r(n.deletedCount)})})},writable:!0,configurable:!0},findOne:{value:function(e,n){var t=this;return n=castQueryIds(n),new Promise(function(r,i){t._mongo.collection(e).findOne(n,function(e,n){return e?i(e):r(n)})})},writable:!0,configurable:!0},findOneAndUpdate:{value:function(e,n,t,r){var i=this;return n=castQueryIds(n),r||(r={}),r.returnOriginal=!1,new Promise(function(o,u){var a=i._mongo.collection(e),c=t;c=r.upsert?{$setOnInsert:c}:{$set:c},a.findOneAndUpdate(n,c,r,function(e,n){if(e)return u(e);o(n.value)})})},writable:!0,configurable:!0},findOneAndDelete:{value:function(e,n,t){var r=this;return n=castQueryIds(n),t||(t={}),new Promise(function(i,o){r._mongo.collection(e).findOneAndDelete(n,t,function(e,n){return e?o(e):i(null===n.value?0:1)})})},writable:!0,configurable:!0},find:{value:function(e,n,t){var r=this;return n=castQueryIds(n),new Promise(function(i,o){var u=r._mongo.collection(e),a=u.find(n);t.sort&&(_.isArray(t.sort)||_.isString(t.sort))&&function(){var e={};_.isArray(t.sort)||(t.sort=[t.sort]),t.sort.forEach(function(n){if(_.isString(n)){var t=1;"-"===n[0]&&(t=-1,n=n.substring(1)),e[n]=t}}),a=a.sort(e)}(),"number"==typeof t.skip&&(a=a.skip(t.skip)),"number"==typeof t.limit&&(a=a.limit(t.limit)),a.toArray(function(e,n){return e?o(e):i(n)})})},writable:!0,configurable:!0},count:{value:function(e,n){var t=this;return n=castQueryIds(n),new Promise(function(r,i){t._mongo.collection(e).count(n,function(e,n){return e?i(e):r(n)})})},writable:!0,configurable:!0},createIndex:{value:function(e,n,t){t=t||{},t.unique=t.unique||!1,t.sparse=t.sparse||!1;var r=this._mongo.collection(e),i={};i[n]=1,r.createIndex(i,{unique:t.unique,sparse:t.sparse})},writable:!0,configurable:!0},close:{value:function(){var e=this;return new Promise(function(n,t){e._mongo.close(function(e){return e?t(e):n()})})},writable:!0,configurable:!0},clearCollection:{value:function(e){var n=this;return new Promise(function(t,r){n._mongo.dropCollection(e,function(e,n){return e?r(e):t()})})},writable:!0,configurable:!0},dropDatabase:{value:function(){var e=this;return new Promise(function(n,t){e._mongo.dropDatabase(function(e,r){return e?t(e):n()})})},writable:!0,configurable:!0},toCanonicalId:{value:function(e){return e.toString()},writable:!0,configurable:!0},isNativeId:{value:function(e){return e instanceof ObjectId||null!==String(e).match(/^[a-fA-F0-9]{24}$/)},writable:!0,configurable:!0},nativeIdType:{value:function(){return ObjectId},writable:!0,configurable:!0},driver:{value:function(){return this._mongo},writable:!0,configurable:!0}}),n}(DatabaseClient),castId=function(e){return new ObjectId(e)},castIdArray=function(e){return e.map(function(e){return castId(e)})},castQueryIds=function(e){return deepTraverse(e,function(e,n,t){"_id"===e&&(String(t[e]).match(/^[a-fA-F0-9]{24}$/)?t[e]=castId(t[e]):isObject(t[e])&&_.has(t[e],"$in")?t[e].$in=castIdArray(t[e].$in):isObject(t[e])&&_.has(t[e],"$nin")&&(t[e].$nin=castIdArray(t[e].$nin)))}),e};module.exports=MongoClient;