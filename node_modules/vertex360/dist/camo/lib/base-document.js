"use strict";var _prototypeProperties=function(e,t,a){t&&Object.defineProperties(e,t),a&&Object.defineProperties(e.prototype,a)},_classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},_=require("lodash"),deprecate=require("depd")("vertex360"),DB=require("./clients").getClient,isSupportedType=require("./validate").isSupportedType,isValidType=require("./validate").isValidType,isEmptyValue=require("./validate").isEmptyValue,isInChoices=require("./validate").isInChoices,isArray=require("./validate").isArray,isDocument=require("./validate").isDocument,isEmbeddedDocument=require("./validate").isEmbeddedDocument,isString=require("./validate").isString,isNumber=require("./validate").isNumber,isDate=require("./validate").isDate,ValidationError=require("./errors").ValidationError,normalizeType=function(e){var t={};if(e.type)t=e;else{if(!isSupportedType(e))throw new Error("Unsupported type or bad variable. Remember, non-persisted objects must start with an underscore (_). Got:",e);t.type=e}return t},currentlySupported=["type","default","min","max","choices","match","validate","unique","required"],customOpts=function(e){var t=Object.assign({},e);return currentlySupported.forEach(function(e){delete t[e]}),0==Object.keys(t).length?null:t},BaseDocument=function(){function e(){_classCallCheck(this,e),this._schema={_id:{type:DB().nativeIdType()}},this._id=null}return _prototypeProperties(e,{documentClass:{value:function(){throw new TypeError("You must override documentClass (static).")},writable:!0,configurable:!0},collectionName:{value:function(){var e=new this;return e._meta?e._meta.collection:this.name.toLowerCase()+"s"},writable:!0,configurable:!0},create:{value:function(e){return this.createIndexes(),void 0!==e?this._fromData(e):this._instantiate()},writable:!0,configurable:!0},createIndexes:{value:function(){},writable:!0,configurable:!0},_instantiate:{value:function(){var e=new this;return e.generateSchema(),e},writable:!0,configurable:!0},_fromData:{value:function(e){var t=this;isArray(e)||(e=[e]);var a=[];return e.forEach(function(e){var i=t._instantiate();_.keys(e).forEach(function(t){var a=null;a=null===e[t]?i.getDefault(t):e[t],t in i._schema?function(){var e=i._schema[t].type;e.documentClass&&"embedded"===e.documentClass()?i[t]=e._fromData(a):isArray(e)&&e.length>0&&e[0].documentClass&&"embedded"===e[0].documentClass()?(i[t]=[],a.forEach(function(a,r){i[t][r]=e[0]._fromData(a)})):i[t]=a}():t in i&&(i[t]=a)}),a.push(i)}),1===a.length?a[0]:a},writable:!0,configurable:!0},populate:{value:function(e,t){if(!e)return Promise.all([]);var a=null;if(isArray(e)){if(e.length<1)return Promise.all(e);a=e}else a=[e];var i=[],r=a[0];_.keys(r._schema).forEach(function(e){isArray(t)&&t.indexOf(e)<0||(isArray(r._schema[e].type)&&r._schema[e].type.length>0&&isDocument(r._schema[e].type[0])?i.push(e):(isString(r[e])||DB().isNativeId(r[e]))&&isDocument(r._schema[e].type)&&i.push(e))});var n={};i.forEach(function(e){n[e]={},a.forEach(function(t){n[e][DB().toCanonicalId(t._id)]=[].concat(t[e]),isArray(t[e])&&(t[e]=[])})});var o=[];return _.keys(n).forEach(function(e){var t=[];_.keys(n[e]).forEach(function(a){t=t.concat(n[e][a])}),t=_.unique(t);var i=null;i=isArray(r._schema[e].type)?r._schema[e].type[0]:r._schema[e].type;var s=i.find({_id:{$in:t}},{populate:!1}).then(function(t){_.keys(n[e]).forEach(function(i){var o=void 0;a.forEach(function(e){DB().toCanonicalId(e._id)===i&&(o=e)}),n[e][i].forEach(function(a){var i=void 0;t.forEach(function(e){DB().toCanonicalId(e._id)===DB().toCanonicalId(a)&&(i=e)}),isArray(r._schema[e].type)?o[e].push(i):o[e]=i})})});o.push(s)}),Promise.all(o).then(function(){return e})},writable:!0,configurable:!0}},{documentClass:{value:function(){throw new TypeError("You must override documentClass.")},writable:!0,configurable:!0},collectionName:{value:function(){return this._meta?this._meta.collection:this.constructor.collectionName()},writable:!0,configurable:!0},id:{get:function(){return deprecate("Document.id - use Document._id instead"),this._id},set:function(e){deprecate("Document.id - use Document._id instead"),this._id=e},configurable:!0},schema:{value:function(e){null==e.opts&&function(){var t={};Object.keys(e).forEach(function(a){var i=e[a],r=customOpts(i);null!=r&&(t[a]=r,1==r.display&&(t.display=a))}),e.opts=t}(),this._props=e;var t=this;e&&_.keys(e).forEach(function(a){t[a]=e[a]})},writable:!0,configurable:!0},preValidate:{value:function(){},writable:!0,configurable:!0},postValidate:{value:function(){},writable:!0,configurable:!0},preSave:{value:function(){},writable:!0,configurable:!0},postSave:{value:function(){},writable:!0,configurable:!0},preDelete:{value:function(){},writable:!0,configurable:!0},postDelete:{value:function(){},writable:!0,configurable:!0},preFetch:{value:function(){},writable:!0,configurable:!0},postFetch:{value:function(){},writable:!0,configurable:!0},generateSchema:{value:function(){var e=this;_.keys(this).forEach(function(t){_.startsWith(t,"_")||(e._schema[t]=normalizeType(e[t]),isArray(e._schema[t].type)?e[t]=e.getDefault(t)||[]:e[t]=e.getDefault(t))})},writable:!0,configurable:!0},validate:{value:function(){var e=this;_.keys(e._schema).forEach(function(t){var a=e[t];if(null!==a&&void 0!==a){if(isEmbeddedDocument(a))return void a.validate();if(isArray(a)&&a.length>0&&isEmbeddedDocument(a[0]))return void a.forEach(function(e){e.validate&&e.validate()})}if(!isValidType(a,e._schema[t].type)){var i=null,r=null;throw i=Array.isArray(e._schema[t].type)&&e._schema[t].type.length>0?"["+e._schema[t].type[0].name+"]":Array.isArray(e._schema[t].type)&&0===e._schema[t].type.length?"[]":e._schema[t].type.name,r=Array.isArray(a)?"["+a.toString()+"]":typeof a,new ValidationError("Value assigned to "+e.collectionName()+"."+t+" should be "+i+", got "+r)}if(e._schema[t].required&&isEmptyValue(a))throw new ValidationError("Key "+e.collectionName()+"."+t+" is required, but got "+a);if(e._schema[t].match&&isString(a)&&!e._schema[t].match.test(a))throw new ValidationError("Value assigned to "+e.collectionName()+"."+t+" does not match the regex/string "+e._schema[t].match.toString()+". Value was "+a);if(!isInChoices(e._schema[t].choices,a))throw new ValidationError("Value assigned to "+e.collectionName()+"."+t+" should be in choices ["+e._schema[t].choices.join(", ")+"], got "+a);if(isNumber(e._schema[t].min)&&a<e._schema[t].min)throw new ValidationError("Value assigned to "+e.collectionName()+"."+t+" is less than min, "+e._schema[t].min+", got "+a);if(isNumber(e._schema[t].max)&&a>e._schema[t].max)throw new ValidationError("Value assigned to "+e.collectionName()+"."+t+" is less than max, "+e._schema[t].max+", got "+a);if("function"==typeof e._schema[t].validate&&!e._schema[t].validate(a))throw new ValidationError("Value assigned to "+e.collectionName()+"."+t+" failed custom validator. Value was "+a)})},writable:!0,configurable:!0},canonicalize:{value:function(){var e=this;_.keys(e._schema).forEach(function(t){var a=e[t];if(e._schema[t].type===Date&&isDate(a))e[t]=new Date(a);else if(null!==a&&void 0!==a&&a.documentClass&&"embedded"===a.documentClass())return void a.canonicalize()})},writable:!0,configurable:!0},populate:{value:function(){return e.populate(this)},writable:!0,configurable:!0},getDefault:{value:function(e){if(e in this._schema&&"default"in this._schema[e]){var t=this._schema[e].default,a="function"==typeof t?t():t;return this[e]=a,a}if("_id"===e)return null},writable:!0,configurable:!0},toJSON:{value:function(){var e=this._toData({_id:!0}),t=this._schema;for(var a in t)t.hasOwnProperty(a)&&(t[a].private?delete e[a]:e[a]&&e[a].toJSON?e[a]=e[a].toJSON():isArray(e[a])&&function(){var t=[];e[a].forEach(function(e){e&&e.toJSON?t.push(e.toJSON()):t.push(e)}),e[a]=t}());return e},writable:!0,configurable:!0},_toData:{value:function(e){var t=this;void 0===e||null===e?e={}:void 0===e._id&&(e._id=!0);var a={};return _.keys(this).forEach(function(i){if(_.startsWith(i,"_")){if("_id"!==i||!e._id)return;a[i]=t[i]}else isEmbeddedDocument(t[i])?a[i]=t[i]._toData():isArray(t[i])&&t[i].length>0&&isEmbeddedDocument(t[i][0])?(a[i]=[],t[i].forEach(function(e){a[i].push(e._toData())})):a[i]=t[i]}),a},writable:!0,configurable:!0},_getEmbeddeds:{value:function(){var e=this,t=[];return _.keys(this._schema).forEach(function(a){(isEmbeddedDocument(e._schema[a].type)||isArray(e._schema[a].type)&&isEmbeddedDocument(e._schema[a].type[0]))&&(t=t.concat(e[a]))}),t},writable:!0,configurable:!0},_getHookPromises:{value:function(e){var t=this._getEmbeddeds(),a=[];return a=a.concat(_.invoke(t,e)),a.push(this[e]()),a},writable:!0,configurable:!0}}),e}();module.exports=BaseDocument;