"use strict";var _prototypeProperties=function(e,t,n){t&&Object.defineProperties(e,t),n&&Object.defineProperties(e.prototype,n)},_get=function e(t,n,r){var o=Object.getOwnPropertyDescriptor(t,n);if(void 0===o){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,n,r)}if("value"in o&&o.writable)return o.value;var i=o.get;if(void 0!==i)return i.call(r)},_inherits=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(e.__proto__=t)},_classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},_=require("lodash"),deprecate=require("depd")("vertex360"),DB=require("./clients").getClient,BaseDocument=require("./base-document"),isSupportedType=require("./validate").isSupportedType,isArray=require("./validate").isArray,isReferenceable=require("./validate").isReferenceable,isEmbeddedDocument=require("./validate").isEmbeddedDocument,isString=require("./validate").isString,backupDefaults={string:"",number:0,array:[],object:{},boolean:!1},formatValues=function(e,t){var n=Object.assign({},e);return Object.keys(t).forEach(function(r){var o=e[r];if(null!=o){var a=t[r];"string"==typeof o&&(1==a.lowercase&&(o=o.toLowerCase()),1==a.uppercase&&(o=o.toUpperCase()),1==a.trim&&(o=o.trim()),n[r]=o)}}),n},preFetchAndPreSave=function(e){return Promise.all(e._getHookPromises("preFetch")).then(function(){return Promise.all(e._getHookPromises("preSave"))})},Document=function(e){function t(e){_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).call(this),void 0!==e&&null!==e&&(deprecate("Document.constructor(name) - override Document.collectionName() instead"),this._meta={collection:e})}return _inherits(t,e),_prototypeProperties(t,{documentClass:{value:function(){return"document"},writable:!0,configurable:!0},schema:{value:function(){var e=new this;if(null==e._props)return null;var t=e._props;if("object"!=typeof t)return null;var n={},r=Object.keys(t);return n.opts=null==t.opts?{}:t.opts.default||t.opts,r.forEach(function(e){if("opts"!=e){var r=Object.assign({},t[e]),o=r.type.toString(),a=o.split(" ");r.type=a[1].replace("()",""),n[e]=null==n.opts[e]?r:Object.assign({},r,n.opts[e])}}),n},writable:!0,configurable:!0},resourceName:{get:function(){return(new this).constructor.name.toLowerCase()},configurable:!0},collectionName:{value:function(){var e=new this,t=e.constructor.name.toLowerCase(),n=t.charAt(t.length-1);return"s"===n||"z"===n?t+"es":t+"s"},writable:!0,configurable:!0},schemaName:{value:function(){return(new this).constructor.name.toLowerCase()},writable:!0,configurable:!0},convertToJson:{value:function(e){return e.map(function(e){return e.summary()})},writable:!0,configurable:!0},create:{value:function(e){var t=new this;if(null==t._props)return t.save();var n=t._props;if("object"!=typeof n)return t.save();var r=this.schema().opts,o=this.schema(),r=o.opts;return r&&(e=formatValues(e,r)),Object.keys(n).forEach(function(r){var a=e[r]||n[r].default,i=typeof a;Array.isArray(a)&&(i="array"),a instanceof Date&&(i="date");var u=o[r].type;if(u){var l=null;if((l="function"==typeof u.toLowerCase?u.toLowerCase():u)!==i)return void(t[r]="date"===l?new Date:backupDefaults[l])}t[r]=a}),t.timestamp=new Date,t.save()},writable:!0,configurable:!0},deleteOne:{value:function(e){var t=this,n=new t;return preFetchAndPreSave(n).then(function(){return Promise.all(n._getHookPromises("preDelete"))}).then(function(){return DB().deleteOne(t.collectionName(),e)}).then(function(e){return Promise.all(n._getHookPromises("postDelete"))})},writable:!0,configurable:!0},deleteMany:{value:function(e){void 0!==e&&null!==e||(e={});var t=this,n=new t;return preFetchAndPreSave(n).then(function(){return Promise.all(n._getHookPromises("preDelete"))}).then(function(){return DB().deleteMany(t.collectionName(),e)}).then(function(e){return Promise.all(n._getHookPromises("postDelete"))})},writable:!0,configurable:!0},loadOne:{value:function(e,t){return deprecate("loadOne - use findOne instead"),this.findOne(e,t)},writable:!0,configurable:!0},findOne:{value:function(e,t){var n=new this,r=this,o=!0;return t&&t.hasOwnProperty("populate")&&(o=t.populate),Promise.all(n._getHookPromises("preFetch")).then(function(){return DB().findOne(r.collectionName(),e)}).then(function(e){if(!e)return null;var t=r._fromData(e);return!0===o||isArray(o)&&o.length>0?r.populate(t,o):t}).then(function(e){return e||null})},writable:!0,configurable:!0},findById:{value:function(e,t){var n={_id:e},r=new this,o=this,a=!0;return t&&t.hasOwnProperty("populate")&&(a=t.populate),Promise.all(r._getHookPromises("preFetch")).then(function(){return DB().findOne(o.collectionName(),n)}).then(function(e){if(!e)return null;var t=o._fromData(e);return!0===a||isArray(a)&&a.length>0?o.populate(t,a):t}).then(function(e){return e||null})},writable:!0,configurable:!0},loadOneAndUpdate:{value:function(e,t,n){return deprecate("loadOneAndUpdate - use findOneAndUpdate instead"),this.findOneAndUpdate(e,t,n)},writable:!0,configurable:!0},findOneAndUpdate:{value:function(e,t,n){var r=this;if(arguments.length<2)throw new Error("findOneAndUpdate requires at least 2 arguments. Got "+arguments.length+".");n||(n={});var o=!0;n.hasOwnProperty("populate")&&(o=n.populate);var a=null,i=new r;return preFetchAndPreSave(i).then(function(){return DB().findOneAndUpdate(r.collectionName(),e,t,n)}).then(function(e){if(!e)return null;var t=r._fromData(e);return o?r.populate(t):t}).then(function(e){e&&(a=e);var t=i._getHookPromises("postSave");return Promise.all(t)}).then(function(e){return a})},writable:!0,configurable:!0},findByIdAndUpdate:{value:function(e,t,n){var r=this.schema().opts;r&&(t=formatValues(t,r));var o={_id:e},a=this;if(arguments.length<2)throw new Error("findOneAndUpdate requires at least 2 arguments. Got "+arguments.length+".");n||(n={});var i=!0;n.hasOwnProperty("populate")&&(i=n.populate);var u=null,l=new a;return preFetchAndPreSave(l).then(function(){return DB().findOneAndUpdate(a.collectionName(),o,t,n)}).then(function(e){if(!e)return null;var t=a._fromData(e);return i?a.populate(t):t}).then(function(e){return e&&(u=e),Promise.all(l._getHookPromises("postSave"))}).then(function(e){return u})},writable:!0,configurable:!0},loadOneAndDelete:{value:function(e,t){return deprecate("loadOneAndDelete - use findOneAndDelete instead"),this.findOneAndDelete(e,t)},writable:!0,configurable:!0},findOneAndDelete:{value:function(e,t){var n=this;if(arguments.length<1)throw new Error("findOneAndDelete requires at least 1 argument. Got "+arguments.length+".");t||(t={});var r=new n;return preFetchAndPreSave(r).then(function(){return DB().findOneAndDelete(n.collectionName(),e,t)}).then(function(e){return Promise.all(r._getHookPromises("postDelete"))})},writable:!0,configurable:!0},findByIdAndRemove:{value:function(e,t){var n={_id:e},r=this;if(arguments.length<1)throw new Error("findOneAndDelete requires at least 1 argument. Got "+arguments.length+".");t||(t={});var o=new r;return preFetchAndPreSave(o).then(function(){return DB().findOneAndDelete(r.collectionName(),n,t)}).then(function(e){var t=new r;return Promise.all(t._getHookPromises("postDelete"))})},writable:!0,configurable:!0},loadMany:{value:function(e,t){return deprecate("loadMany - use find instead"),this.find(e,t)},writable:!0,configurable:!0},find:{value:function(e,t){var n=this;void 0!==e&&null!==e||(e={}),void 0!==t&&null!==t||(t={populate:!0});var r=new this,o=this,a=null;return Promise.all(r._getHookPromises("preFetch")).then(function(){return DB().find(o.collectionName(),e,t)}).then(function(e){return a=n._fromData(e),!0===t.populate||isArray(t.populate)&&t.populate.length>0?n.populate(a,t.populate):a}).then(function(){return Promise.all(r._getHookPromises("postFetch"))}).then(function(){return[].concat(a)})},writable:!0,configurable:!0},count:{value:function(e){return DB().count(this.collectionName(),e)},writable:!0,configurable:!0},createIndexes:{value:function(){if(!this._indexesCreated){var e=this,t=this._instantiate();_.keys(t._schema).forEach(function(n){t._schema[n].unique&&DB().createIndex(e.collectionName(),n,{unique:!0})}),this._indexesCreated=!0}},writable:!0,configurable:!0},_fromData:{value:function(e){var n=_get(Object.getPrototypeOf(t),"_fromData",this).call(this,e);[].concat(e),[].concat(n);return n},writable:!0,configurable:!0},clearCollection:{value:function(){return DB().clearCollection(this.collectionName())},writable:!0,configurable:!0}},{documentClass:{value:function(){return"document"},writable:!0,configurable:!0},summary:{value:function(){var e=Object.assign({id:this._id},this);return e.schema=this.constructor.schemaName(),delete e.opts,delete e._schema,delete e._props,delete e._id,e},writable:!0,configurable:!0},meta:{get:function(){return this._meta},set:function(e){this._meta=e},configurable:!0},save:{value:function(){var e=this,t=this._getHookPromises("preValidate");return Promise.all(t).then(function(){return _.keys(e._schema).forEach(function(t){t in e._schema||(e[t]=e.getDefault(t))}),e.validate(),e.canonicalize(),Promise.all(e._getHookPromises("postValidate"))}).then(function(){return preFetchAndPreSave(e)}).then(function(){var t=e._toData({_id:!1});return _.keys(e._schema).forEach(function(n){"_id"!==n&&(isReferenceable(e[n])||isArray(e[n])&&e[n].length>0&&isReferenceable(e[n][0]))&&(isArray(e[n])?(t[n]=[],e[n].forEach(function(e){DB().isNativeId(e)?t[n].push(e):t[n].push(e._id)})):DB().isNativeId(e[n])?t[n]=e[n]:t[n]=e[n]._id)}),_.keys(e._schema).forEach(function(n){(isEmbeddedDocument(e[n])||isArray(e[n])&&e[n].length>0&&isEmbeddedDocument(e[n][0]))&&(isArray(e[n])?(t[n]=[],e[n].forEach(function(e){t[n].push(e._toData())})):t[n]=e[n]._toData())}),DB().save(e.collectionName(),e._id,t)}).then(function(t){null===e._id&&(e._id=t)}).then(function(){var t=e._getHookPromises("postSave");return Promise.all(t)}).then(function(){return e}).catch(function(e){return Promise.reject(e)})},writable:!0,configurable:!0},delete:{value:function(){var e=this,t=e._getHookPromises("preDelete");return Promise.all(t).then(function(){return DB().delete(e.collectionName(),e._id)}).then(function(t){var n=[t].concat(e._getHookPromises("postDelete"));return Promise.all(n)}).then(function(e){return e[0]})},writable:!0,configurable:!0}}),t}(BaseDocument);module.exports=Document;