const cookie=require("cookie"),sessions=require("client-sessions"),utils=require("./utils"),COOKIE_NAME="vertexSession",VERTEX360_URL="https://vertex360.herokuapp.com",parseBody=e=>{if(null==e.body)return null;let r={};try{r=JSON.parse(e.body)}catch(t){e.body.split("&").forEach((e,t)=>{let o=e.split("=");2==o.length&&(r[o[0]]=decode(o[1]))})}return r},parseSession=(e,r)=>new Promise((t,o)=>{var n=e.headers.Cookie;if(null!=n){var s=cookie.parse(n);if(null!=s[r])try{const e=sessions.util.decode({cookieName:r,secret:"abc"},s[r]);if(null==e)return void t(null);if(null==e.content)return void t(null);t(JSON.parse(e.content))}catch(e){return void o(e)}else t(null)}else t(null)}),validateRequest=e=>{const r=parseBody(e);if(null==r)throw new Error("Missing post body.");const t=e.headers["VERTEX-TOKEN"]||e.headers["vertex-token"];if(null==t)throw new Error("Invalid request.");return{user:r,token:t}},generateCookieString=(e,r)=>{if(null==r){return e+"=deleted; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT"}const t=JSON.stringify(r);return e+"="+sessions.util.encode({cookieName:e,secret:"abc"},t,null,null)+"; path=/; max-age=1209600"};module.exports=(e=>new Promise((r,t)=>{const o=e.path.split("/"),n=[];e.httpMethod.toLowerCase();if(o.forEach(e=>{e.length>0&&"/"!=e&&n.push(e)}),2!=n.length)return void t(new Error("invalid path. must folow /auth/:action"));if("auth"!=n[0])return void t(new Error("invalid path. must folow /auth/:action"));const s=n[1];if("login"!=s){if("token"==s){const o=parseBody(e);return null==o?void t(new Error("Missing post body.")):(o.encode="base64",void utils.post(VERTEX360_URL+"/account/verifytoken",o).then(e=>{if("success"!=e.confirmation)throw new Error(e.message);r({vertexUser:e.user,cookie:generateCookieString(COOKIE_NAME,{vertexUser:e.user})})}).catch(function(e){t(e)}))}if("register"!=s)"currentuser"!=s?"logout"!=s?t(new Error("Invalid auth action: "+s)):r({vertexUser:null,cookie:generateCookieString(COOKIE_NAME,null)}):parseSession(e,COOKIE_NAME).then(e=>{const t=e?e.vertexUser:null;r({vertexUser:t,cookie:null})}).catch(e=>{r({vertexUser:null,cookie:null})});else{let o=null;try{o=validateRequest(e)}catch(e){return void t(e)}utils.post(VERTEX360_URL+"/account/verifytoken",{profile:o.user.id,token:o.token}).then(e=>{if("success"!=e.confirmation)throw new Error(e.message);r({vertexUser:e.user,cookie:generateCookieString(COOKIE_NAME,{vertexUser:e.user})})}).catch(function(e){t(e)})}}else{let o=null;try{o=validateRequest(e)}catch(e){return void t(e)}utils.post(VERTEX360_URL+"/account/verifytoken",{profile:o.user.id,token:o.token}).then(e=>{if("success"!=e.confirmation)throw new Error(e.message);r({vertexUser:e.user,cookie:generateCookieString(COOKIE_NAME,{vertexUser:e.user})})}).catch(function(e){t(e)})}}));