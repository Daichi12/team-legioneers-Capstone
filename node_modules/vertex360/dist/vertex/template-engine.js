var Hogan=require("hogan.js"),ReadDir=require("readdir"),Path=require("path"),FS=require("fs"),debug=require("debug")("hogan"),utils=require("./utils"),NODE_MODULES_PATH="win32"==process.platform?"node_modules\\vertex360\\dist\\vertex":"node_modules/vertex360/dist/vertex";function TemplateEngine(e){return e&&Object.keys(e).forEach(function(t){if(!TemplateEngine.__settings.hasOwnProperty(t))throw"hogan-middleware: unknown setting, attempted to set value for "+t;TemplateEngine.__settings[t]=e[t]}),TemplateEngine}var checkLocalPageConfig=function(e,t){if(!t.page){var n=Path.join(__dirname,"/pages/"+e+".json").replace(NODE_MODULES_PATH,"");if(FS.existsSync(n)){var a=FS.readFileSync(n);try{t.page=JSON.parse(a)}catch(e){}}}};function findTemplates(e,t){return ReadDir.readSync(e,t,ReadDir.ABSOLUTE_PATHS)}function readTemplate(e){return{content:Hogan.compile(FS.readFileSync(e,"utf-8")),path:stripFileExtension(e)}}function stripFileExtension(e){return e.replace(/(.+)\.[a-z]+/,"$1")}TemplateEngine.__settings={filter:["**.mustache"],flatten:!0,watch:!0},TemplateEngine._watches=[],TemplateEngine.__express=function(e,t,n){var a=stripFileExtension(Path.relative(t.settings.views,e)),r=TemplateEngine._getTemplates(t.settings.views),i=null,s=null;if("widget"!=process.env["TURBO-VERTEX-CLIENT"]){if("prod"===process.env.TURBO_ENV)return process.env.TURBO_APP_SLUG||(i=r[a].render(t,r),n(s,i)),void utils.checkPageConfig(a,process.env.TURBO_APP_SLUG).then(e=>{try{t.page=e,i=r[a].render(t,r)}catch(e){s=e}finally{n(s,i)}}).catch(e=>{i=r[a].render(t,r),n(s,i)});"dev"===process.env.TURBO_ENV&&checkLocalPageConfig(a,t);try{i=r[a].render(t,r)}catch(e){s=e}finally{n(s,i)}}else utils.checkPageConfig(a,process.env.TURBO_APP_SLUG).then(e=>{try{i={page:e,pageName:a}}catch(e){s=e}finally{n(s,i)}}).catch(e=>{n(s,i=t)})},TemplateEngine._getTemplates=function(e){return TemplateEngine.__templates||(TemplateEngine._refreshTemplates(e),FS.watch(e,{persistent:!1},function(t,n,a){return TemplateEngine._refreshTemplates(e)})),TemplateEngine.__templates},TemplateEngine._refreshWatches=function(e){!1!==TemplateEngine.__settings.watch?(debug("Refreshing watched directories"),TemplateEngine._watches.splice(0).forEach(function(e){e.close()}),ReadDir.readSync(e,["**/"],ReadDir.ABSOLUTE_PATHS+ReadDir.INCLUDE_DIRECTORIES).forEach(function(t){debug(" [WATCH] %s",t),TemplateEngine._watches.push(FS.watch(t,{persistent:!1},TemplateEngine._refreshTemplates.bind(TemplateEngine,e)))})):debug("Refreshing watched directories has been disabled.")},TemplateEngine._refreshTemplates=function(e){debug("Refreshing templates for %s",e),TemplateEngine._refreshWatches(e);var t=TemplateEngine.__settings;findTemplates(e,t.filter).map(readTemplate).reduce(function(n,a){return t.flatten&&(n[Path.basename(a.path)]=a.content),n[Path.relative(e,a.path)]=a.content,n},TemplateEngine.__templates={}),debug("Refreshing templates complete")},module.exports=TemplateEngine;