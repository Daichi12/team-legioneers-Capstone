const formatCallback=require("./callback"),adminRest=require("./adminRest"),authHandler=require("./authHandler"),Router=require("./Router"),db=require("./db"),generateErrorCallback=(e,t,r)=>{return{isBase64Encoded:!1,statusCode:t,headers:r||{"Content-Type":"application/json"},body:JSON.stringify({confirmation:"fail",data:{message:e.message,stack:e.stack}})}},generateSuccessCallback=(e,t)=>{return{isBase64Encoded:!1,statusCode:200,headers:t||{"Content-Type":"application/json"},body:JSON.stringify({confirmation:"success",data:e})}},logString=e=>{let t=e.httpMethod.toLowerCase().toUpperCase()+" "+e.path;return null!=e.headers["User-Agent"]&&(t+=" "+e.headers["User-Agent"]),null==e.requestContext?t:null==e.requestContext.identity?t:null==e.requestContext.identity.sourceIp?t:t+=" "+e.requestContext.identity.sourceIp};class Vertex{constructor(e){if(this.routes=[],this.middleware=[],this.staticDir="public",this.opts=e,this.logging=!1,null==e)return;this.staticDir=e.static||"public",this.logging=e.logging||!1;const t=e.db;null!=t&&(t.type,db.connectNedb(t.url,t.onError,t.onSuccess))}expressVersion(e){var t=this;return e.use("/turbo",(e,r,l)=>{r.json({confirmation:"success",data:JSON.stringify(t.routes)})}),t.routes.forEach(t=>{e.use(t.stem,(e,r,l)=>{r.json({confirmation:"success",data:t.stem})})}),e}useStatic(e){this.staticDir=e}use(e,t){null!=t?(t.setStem(e),this.routes.push(t)):this.middleware.push(e)}get(e,t){var r=new Router;r.setStem("/"),r.get(e,t),this.routes.push(r)}post(e,t){var r=new Router;r.setStem("/"),r.post(e,t),this.routes.push(r)}routeNotFound(e,t){e.httpMethod.toLowerCase();return{isBase64Encoded:!1,statusCode:501,headers:{"Content-Type":"application/json"},body:JSON.stringify({confirmation:"fail",message:t})}}handle(e){const t=e.event,r=e.callback,l=t.httpMethod.toLowerCase(),s=t.headers["turbo-vertex-client"];if("admin-dashboard"==s||"mothership"==s){const e=this.opts.controllers||null;return null==e?void r(null,generateErrorCallback(new Error("controllers not defined. check config settings."),500)):void adminRest(e,t).then(e=>{r(null,generateSuccessCallback(e))}).catch(e=>{r(null,generateErrorCallback(e,500))})}if("vertex-sdk"==s){const e=t.path,l=[];e.split("/").forEach(e=>{e.length>0&&"/"!=e&&l.push(e)});const s={message:"site pinged"};return 0==l.length?void r(null,generateSuccessCallback(s)):(l[0],void r(null,generateSuccessCallback(s)))}if("widget-auth"!=s){if(this.logging){const e=logString(t);console.log(e)}if("post"==l){let e=null;for(let r=0;r<this.routes.length;r++){let l=this.routes[r];if(null!=l.handlePost(t)){e=l.handlePost(t);break}}return null==e?void r(null,this.routeNotFound(t,l+" route not defined for this path: "+t.path)):void formatCallback(t,r,e.routeParams,this.opts,this.middleware,(t,l)=>{if(null==t)try{e.routeHandler(l.req,l.res)}catch(t){return void r(null,generateErrorCallback(t,500))}else r(null,generateErrorCallback(t,500))})}if("put"==l){let e=null;for(let r=0;r<this.routes.length;r++){let l=this.routes[r];if(null!=l.handlePut(t)){e=l.handlePut(t);break}}return null==e?void r(null,this.routeNotFound(t,l+" route not defined for this path: "+t.path)):void formatCallback(t,r,e.routeParams,this.opts,this.middleware,(t,l)=>{if(null==t)try{e.routeHandler(l.req,l.res)}catch(t){return void r(null,generateErrorCallback(t,500))}else r(null,generateErrorCallback(t,500))})}if("delete"==l){let e=null;for(let r=0;r<this.routes.length;r++){let l=this.routes[r];if(null!=l.handleDelete(t)){e=l.handleDelete(t);break}}return null==e?void r(null,this.routeNotFound(t,l+" route not defined for this path: "+t.path)):void formatCallback(t,r,e.routeParams,this.opts,this.middleware,(t,l)=>{if(null==t)try{e.routeHandler(l.req,l.res)}catch(t){return void r(null,generateErrorCallback(t,500))}else r(null,generateErrorCallback(t,500))})}if("get"==l){if(-1==t.path.indexOf(".")){let e=null;for(let r=0;r<this.routes.length;r++){let l=this.routes[r];if(null!=l.handleGet(t)){e=l.handleGet(t);break}}return null==e?void r(null,this.routeNotFound(t,l+" route not defined for this path: "+t.path)):void formatCallback(t,r,e.routeParams,this.opts,this.middleware,(t,l)=>{if(null==t)try{e.routeHandler(l.req,l.res)}catch(t){return void r(null,generateErrorCallback(t,500))}else r(null,generateErrorCallback(t,500))})}if(null==t.headers||null==t.headers)return void r(null,{isBase64Encoded:!1,statusCode:500,headers:{"Content-Type":"application/json"},body:JSON.stringify({confirmation:"fail",data:"Missing Turbo-Vertex-App header (headers is null)"})});const e=t.headers["Turbo-Vertex-App"],s=this.staticDir||"public";let n=null;if(null==this.opts){if(null==e)return void r(null,{isBase64Encoded:!1,statusCode:500,headers:{"Content-Type":"application/json"},body:JSON.stringify({confirmation:"fail",data:"Missing Turbo-Vertex-App header"})});n=("cdn.turbo360-vertex.com/"+e+"/"+s+t.path).replace("//","/")}else if(null==this.opts.bucket){if(null==e)return void r(null,{isBase64Encoded:!1,statusCode:500,headers:{"Content-Type":"application/json"},body:JSON.stringify({confirmation:"fail",data:"Missing Turbo-Vertex-App header"})});n=("cdn.turbo360-vertex.com/"+e+"/"+s+t.path).replace("//","/")}else n="s3.amazonaws.com/"+this.opts.bucket+"/"+s+t.path;r(null,{isBase64Encoded:!1,statusCode:301,headers:{Location:"https://"+n},body:""})}}else authHandler(t).then(e=>{const t={"Content-Type":"application/json"};null!=e.cookie&&(t["Set-Cookie"]=e.cookie),r(null,generateSuccessCallback({vertexUser:e.vertexUser},t))}).catch(e=>{r(null,generateErrorCallback(e,500))})}}module.exports=Vertex;