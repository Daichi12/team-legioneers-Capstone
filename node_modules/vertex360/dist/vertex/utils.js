const superagent=require("superagent"),path=require("path"),fs=require("fs"),TURBO_URL="https://turbo-dashboard.herokuapp.com",PLATFORM_VERCTOR_URL="https://platform.turbo360-vector.com",NODE_MODULES_PATH="win32"==process.platform?"node_modules\\vertex360\\dist\\vertex":"node_modules/vertex360/dist/vertex",STANDARD_HEADERS={"Content-Type":"application/json"},BUCKET="turbo360-vertex";let currentSite=null;const generateErrorCallback=(e,t,n)=>{return{isBase64Encoded:!1,statusCode:t,headers:n||STANDARD_HEADERS,body:JSON.stringify({confirmation:"fail",data:{message:e.message,stack:e.stack}})}},generateSuccessCallback=(e,t)=>{return{isBase64Encoded:!1,statusCode:200,headers:t||STANDARD_HEADERS,body:JSON.stringify({confirmation:"success",data:e})}},logString=e=>{let t=e.httpMethod.toLowerCase().toUpperCase()+" "+e.path;return null!=e.headers["User-Agent"]&&(t+=" "+e.headers["User-Agent"]),null==e.requestContext?t:null==e.requestContext.identity?t:null==e.requestContext.identity.sourceIp?t:t+=" "+e.requestContext.identity.sourceIp},writeFile=function(e,t){return new Promise(function(n,r){fs.writeFile(e,t,function(e){e?r(e):n(t)})})},isValidApp=e=>null==e.TURBO_APP_ID?"TURBO_APP_ID":"<TURBO_APP_ID>"==e.TURBO_APP_ID?"TURBO_APP_ID":e.TURBO_APP_ID.length<20?"TURBO_APP_ID":null==e.TURBO_APP_SLUG?"TURBO_APP_SLUG":"<TURBO_APP_SLUG>"==e.TURBO_APP_SLUG?"TURBO_APP_SLUG":e.TURBO_APP_SLUG.length<6?"TURBO_APP_SLUG":null==e.TURBO_API_KEY?"TURBO_API_KEY":"<TURBO_API_KEY>"==e.TURBO_API_KEY?"TURBO_API_KEY":e.TURBO_API_KEY.length<20?"TURBO_API_KEY":null,getRequest=(e,t,n)=>(null==n&&(n={Accept:"application/json"}),new Promise((r,o)=>{superagent.get(e).query(t).set(n).end((e,t)=>{if(e)return void o(e);let s=null;"application/json"==n.Accept&&(s=t.body||t.text),r(s)})})),postRequest=(e,t,n)=>(null==n&&(n={Accept:"application/json"}),new Promise((r,o)=>{superagent.post(e).send(t).set(n).end((e,t)=>{if(e)return void o(e);let s=null;"application/json"==n.Accept&&(s=t.body||t.text),r(s)})})),putRequest=(e,t,n)=>(null==n&&(n={Accept:"application/json"}),new Promise((r,o)=>{superagent.put(e).send(t).set(n).end((e,t)=>{if(e)return void o(e);let s=null;"application/json"==n.Accept&&(s=t.body||t.text),r(s)})})),fetchTextFile=e=>new Promise((t,n)=>{superagent.get(e).query(null).end((e,r)=>{e?n(e):t(r.text)})}),resetPage=(e,t)=>new Promise(function(n,r){if(null!=e)if(null!=t){var o=e+".txt";fetchTextFile("https://s3.amazonaws.com/turbo360-vertex/pages/"+t+"/"+o).then(function(e){fs.writeFileSync("/tmp/"+o,e);var t=JSON.parse(e);n(t)}).catch(function(e){r(e)})}else r(new Error("Missing appslug argument"));else r(new Error("Missing pageName argument"))}),fetchSite=(e,t)=>(null==t&&(t=!0),new Promise((n,r)=>{if(null!=currentSite&&1==t)return void n(currentSite);const o=TURBO_URL+"/api/site/"+e;superagent.get(o).query(null).set("Accept","application/json").end((e,t)=>{if(e)return void r(e);const o=t.body;"success"==o.confirmation?(currentSite=o.result,n(currentSite)):r(new Error(o.message))})})),globalConfig=e=>new Promise(function(t,n){if("dev"==e.TURBO_ENV){const e=path.join(__dirname,"/pages/global.json").replace(NODE_MODULES_PATH,"");return void fs.readFile(e,"utf8",(e,r)=>{if(e)n(e);else try{t(JSON.parse(r))}catch(e){n(e)}})}const r=isValidApp(e);null==r?fetchSite(e.TURBO_APP_ID,!1).then(r=>{r.api.key==e.TURBO_API_KEY?(currentSite=r,t(r.globalConfig)):n(new Error("Unauthorized"))}).catch(e=>{n(e)}):n(new Error("Please Set Your "+r))}),proxyPlatformFunction=(e,t,n)=>new Promise((r,o)=>{null==n&&(n={Accept:"application/json"});const s=PLATFORM_VERCTOR_URL+"/"+e;superagent.post(s).send(t).set(n).end((e,t)=>{if(e)return void o(e);const n=t.body;r(n)})}),checkPageConfig=function(e,t){const n=__dirname.replace("node_modules/vertex360/dist/vertex","");return new Promise(function(r,o){const s=n+"/pages/"+e+".json";if(0==fs.existsSync(s))return void r(null);const i="/tmp/"+e+".txt";if(fs.existsSync(i)){const e=fs.readFileSync(i,"utf8");try{const t=JSON.parse(e);return void r(t)}catch(e){return void r(null)}}else{var a=null;fetchTextFile("https://s3.amazonaws.com/"+BUCKET+"/pages/"+t+"/"+e+".txt").then(e=>(a=JSON.parse(e),writeFile(i,e))).then(e=>{r(a)}).catch(t=>{if(null==t.message||"Forbidden"!=t.message)o(t);else{o(new Error(e+" config file ("+(e+".json")+") not found on staging environment. To fix: $ turbo page "+e+". REFERENCE - https://docs.turbo360.co/page-configuration"))}})}})},parseBody=e=>{if(null==e.body)return null;let t={};try{t=JSON.parse(e.body)}catch(n){e.body.split("&").forEach((e,n)=>{let r=e.split("=");2==r.length&&(t[r[0]]=decode(r[1]))})}return t};module.exports={get:getRequest,post:postRequest,put:putRequest,fetchTextFile:fetchTextFile,writeFile:writeFile,fetchSite:fetchSite,globalConfig:globalConfig,isValidApp:isValidApp,resetPage:resetPage,logString:logString,generateSuccessCallback:generateSuccessCallback,generateErrorCallback:generateErrorCallback,checkPageConfig:checkPageConfig,parseBody:parseBody,slugVersion:(e,t)=>{let n=e.toString().toLowerCase().replace(/\s+/g,"-").replace(/[^\w\-]+/g,"").replace(/\-\-+/g,"-").replace(/^-+/,"").replace(/-+$/,"");if(null==t)return n.toLowerCase();if(t<=0)return n.toLowerCase();for(var r="",o="abcdefghijklmnopqrstuvwxyz0123456789",s=0;s<t;s++)r+=o.charAt(Math.floor(Math.random()*o.length));return n.toLowerCase()+"-"+r},truncateText:(e,t)=>e.length<t?e:e.substring(0,t)+"...",formattedDate:e=>{return null==e&&(e=new Date),e.toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"})},scrapePreview:(e,t,n)=>proxyPlatformFunction("scrapepreview",{text:e,limit:t},n),execute:(e,t,n)=>proxyPlatformFunction(e,t,n)};