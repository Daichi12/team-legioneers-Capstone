const express=require("express"),path=require("path"),logger=require("morgan"),cookieParser=require("cookie-parser"),bodyParser=require("body-parser"),sessions=require("client-sessions"),templateEngine=require("./template-engine"),db=require("./db"),BASE_PATH=__dirname+"/../../../../",CONTENT_TYPES={css:"text/css",js:"text/javascript",png:"image/png",jpg:"image/jpeg",jpg:"image/jpeg",gif:"image/gif",txt:"text/plain",json:"application/json",doc:"application/msword",docx:"application/vnd.openxmlformats-officedocument.wordprocessingml.document",epub:"application/epub+zip",gz:"application/gzip",ico:"image/vnd.microsoft.icon",mp3:"audio/mpeg",mpeg:"video/mpeg",pdf:"application/pdf",ppt:"application/vnd.ms-powerpoint",pptx:"application/vnd.openxmlformats-officedocument.presentationml.presentation",rtf:"application/rtf",svg:"image/svg+xml",tar:"application/x-tar",tif:"image/tiff",tiff:"image/tiff",wav:"audio/wav",woff:"font/woff",woff2:"font/woff2",xhtml:"application/xhtml+xml",xls:"application/vnd.ms-excel",xlsx:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",xml:"text/xml",zip:"application/zip",md:"text/markdown"},configureSession=e=>{const i=e.opts;if(!i.session)return;const o=i.session.cookieName||"vertexSession",s=i.session.secret||process.env.SESSION_SECRET,n=i.session.duration||864e5,t=i.session.activeDuration||18e5;e.use(sessions({cookieName:o,secret:s,duration:n,activeDuration:t}))},configureDB=e=>{const i=e.opts.db;i&&(null==i.type?db.connectNedb(i.url,i.onError,i.onSuccess):(i.type,db.connectNedb(i.url,i.onError,i.onSuccess)))};module.exports=((e,i)=>{if(null!=e){e.opts=i||{},e.use(bodyParser.json()),e.use(bodyParser.urlencoded({extended:!1})),e.use(cookieParser()),e.use(logger("dev")),e.opts.viewEngine?e.set("view engine",e.opts.viewEngine):(e.set("view engine","mustache"),e.engine("mustache",templateEngine.__express));var o=e.opts.views?path.join(BASE_PATH,e.opts.views):path.join(BASE_PATH,"views");e.set("views",o);var s=e.opts.static||"public",n=path.join(BASE_PATH,s),t=process.env.TURBO_CDN;null!=t&&"prod"===process.env.TURBO_ENV?e.use(function(e,i,o){var s=e.originalUrl.split("?")[0].split(".").pop();CONTENT_TYPES[s.toLowerCase()]?i.redirect(t+e.originalUrl):o()}):e.use(express.static(n)),null!=e.opts.session&&configureSession(e),null!=e.opts.db&&configureDB(e)}});