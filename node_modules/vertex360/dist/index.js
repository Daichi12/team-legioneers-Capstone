var Vertex=require("./vertex/Vertex"),Router=require("./vertex/Router"),APIRouter=require("./vertex/APIRouter"),Controller=require("./vertex/Controller"),TaskMgr=require("./vertex/TaskMgr"),ConfigRouter=require("./vertex/ConfigRouter"),utils=require("./vertex/utils"),local=require("./vertex/local"),db=require("./vertex/db"),entry=require("./vertex/entry"),expressConfig=require("./vertex/express-config"),Microservice=function(e){var r=(e.site_id,function(e){if(Object.keys(process.env).forEach(function(e,r){-1!=e.indexOf("AWS_")&&delete process.env[e]}),delete process.env.PATH,delete process.env._HANDLER,delete process.env.LD_LIBRARY_PATH,delete process.env.LAMBDA_TASK_ROOT,delete process.env.LAMBDA_RUNTIME_DIR,"prod"==process.env.TURBO_ENV){var r=new Vertex(e);return r}var r=local.app(e);return r}),t=function(){return local.router()},n=function(e,r,t){return function(n,o,i){n.appSlug=n.headers["Turbo-Vertex-App"],t.globalConfig(e,r).then(function(e){n.global=e,i()}).catch(function(e){i()})}},o=function(e){return function(r,t,n){var o=r.vertexSession?r.vertexSession.vertexUser:null,i={vertexUser:o};if(null==utils.isValidApp(e)){var s={id:e.TURBO_APP_ID,slug:e.TURBO_APP_SLUG,schema:"site",url:r.headers.host||e.TURBO_APP_SLUG+".vertex360.co"};r.site=s,i.site=s,i.entity=s}var l={site:r.site,cdn:"dev"==e.TURBO_ENV?null:e.TURBO_CDN,global:r.global||{},vertexUser:o,preloaded:JSON.stringify(i),setEntity:function(e){i.entity=e,this.preloaded=JSON.stringify(i)},preloadData:function(e,r){i[e]=r,this.preloaded=JSON.stringify(i)}};r.config=l,r.context=l,n()}},i=function(e){return function(r,t,n){r.appSlug=r.headers["Turbo-Vertex-App"];var o=r.vertexSession?r.vertexSession.vertexUser:null,i={vertexUser:o},s={cdn:"dev"==e.TURBO_ENV?null:e.TURBO_CDN,vertexUser:i.vertexUser};if(null==utils.isValidApp(e)){var l={id:e.TURBO_APP_ID,slug:e.TURBO_APP_SLUG,schema:"site",url:r.headers.host||e.TURBO_APP_SLUG+".vertex360.co"};r.site=l,s.site=l,i.site=l,i.entity=l}s.preloaded=JSON.stringify(i),s.setEntity=function(e){i.entity=e,this.preloaded=JSON.stringify(i)},s.preloadData=function(e,r){i[e]=r,this.preloaded=JSON.stringify(i)},utils.globalConfig(e).then(function(e){if(e)try{var t=JSON.parse(e);r.global=t,s.global=t}catch(t){r.global=e,s.global=e}else r.global={},s.global={};r.config=s,r.context=s,n()}).catch(function(e){r.config=s,r.context=s,n()})}},s=function(e){return new Promise(function(r,t){return null==e.profile?void t(new Error("Missing Profile ID")):null==e.token?void t(new Error("Missing token")):void utils.post("https://vertex360.herokuapp.com/account/verifytoken",e).then(function(e){if("success"!=e.confirmation)throw new Error(e.message);r(e.user)}).catch(function(e){t(e)})})},l=function(e,r){expressConfig(e,r),e.use(function(e,r,t){e.appSlug=e.headers["Turbo-Vertex-App"];var n={},o={cdn:"dev"===process.env.TURBO_ENV?null:process.env.TURBO_CDN};if(null==utils.isValidApp(process.env)){var i={id:process.env.TURBO_APP_ID,slug:process.env.TURBO_APP_SLUG,schema:"site",url:e.headers.host||process.env.TURBO_APP_SLUG+".vertex360.co"};e.site=i,o.site=i,n.site=i,n.entity=i}o.preloaded=JSON.stringify(n),o.setEntity=function(e){n.entity=e,this.preloaded=JSON.stringify(n)},o.preloadData=function(e,r){n[e]=r,this.preloaded=JSON.stringify(n)},utils.globalConfig(process.env).then(function(r){if(r)try{var n=JSON.parse(r);e.global=n,o.global=n}catch(t){e.global=r,o.global=r}else e.global={},o.global={};e.config=o,e.context=o,t()}).catch(function(r){e.config=o,e.context=o,t()})})};return{entry:entry,express:r,app:r,router:t,fetchGlobal:n,resetPage:utils.resetPage,setConfig:o,setContext:i,APIRouter:APIRouter,Controller:Controller,TaskMgr:TaskMgr,ConfigRouter:ConfigRouter,nedbConfig:db.nedbConfig,nedb:db.nedb,Model:db.Model,utils:utils,verifyUser:s,configureApp:l}};module.exports=Microservice;